#!/usr/bin/env nu

source scripts/environments.nu
source scripts/fluxcd.nu
source scripts/github.nu
source scripts/kubernetes.nu

def main [] {
    platform --help
}

def "main setup" [] {

    rm --force .env

    let token = (main get github)
    let environment = (main get environment)

    $env.GITHUB_TOKEN = $token

    (
        main create kubernetes
            --environment $environment
    )

    (
        main apply fluxcd
           --environment $environment   
    )
}

# Get status
def "main get status" [] {

    (
        flux get kustomizations 
            --no-header  
            | lines 
            | each {|line | split column "\t" } 
            | flatten 
            | select column1 column4 column5
            | rename Name Ready "Applied Version"
    )
}

